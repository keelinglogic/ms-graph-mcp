# Microsoft Graph MCP Server - Docker Compose Configuration
# Deploy to: /opt/services/m365-mcp/docker-compose.yml on Hermes
#
# Deployment:
#   ./scripts/deploy-to-hermes.sh
#
# Manual deployment:
#   rsync -av src/ hermes:/opt/services/m365-mcp/code/ --exclude __pycache__
#   scp deployment/hermes/docker-compose.yml hermes:/opt/services/m365-mcp/
#   ssh hermes 'cd /opt/services/m365-mcp && docker compose up -d'

services:
  m365-mcp:
    image: python:3.12-slim
    container_name: m365-mcp
    user: "1000:1000"  # Run as non-root for security
    restart: unless-stopped
    ports:
      - "10.100.0.1:8000:8000"  # WireGuard interface only
    volumes:
      - ./code:/app
      - m365-mcp-data:/data
    working_dir: /app
    env_file:
      - code/.env
    environment:
      - ALLOW_UNENCRYPTED_CACHE=true
      - ATHENA_DATA_DIR=/data
      - HOME=/data
      - PIP_CACHE_DIR=/data/.pip-cache
      - PATH=/data/.local/bin:/usr/local/bin:/usr/bin:/bin
    command: >
      sh -c "
        pip install -q --no-cache-dir -r requirements.txt &&
        pip install -q --no-cache-dir mcp-proxy &&
        mcp-proxy --port 8000 --host 0.0.0.0 python3 mcp_server_v2.py
      "
    networks:
      - mcp-network

volumes:
  m365-mcp-data:
    name: m365-mcp-data
    driver: local

networks:
  mcp-network:
    name: mcp-network
    driver: bridge
